(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{"HFx+":function(t,e,i){"use strict";i.r(e),i.d(e,"EditModule",(function(){return M}));var n=i("ofXK"),s=i("tyNb"),o=i("mrSG"),r=i("quSY"),a=i("iA2r"),l=i("D//C"),c=i("RtbK"),u=i.n(c),b=i("nCUg"),h=i("fXoL"),m=i("c3AT"),f=i("sYmb"),d=i("3Pt+"),p=i("wLEN"),g=i("bTqV"),v=i("NFeN"),C=i("+0xr"),S=i("qFsG");function w(t,e){if(1&t){const t=h.Ub();h.Tb(0,"button",12),h.ac("click",(function(){return h.sc(t),h.ec().fillWithPreviousData()})),h.Tb(1,"mat-icon"),h.Dc(2,"edit"),h.Sb(),h.Dc(3," Fill with data from the previous entry "),h.Sb()}}function D(t,e){1&t&&h.Ob(0,"mat-header-cell")}function T(t,e){if(1&t&&(h.Tb(0,"div",25),h.Ob(1,"input",26),h.Sb()),2&t){const t=h.ec().index,e=h.ec().index,i=h.ec(),n=i.$implicit,s=i.index,o=h.ec(2);h.Bb(1),h.kc("formControl",o.inputForm.get("values").get(n.id).controls[o.isInputCell(s,t,e)])}}function y(t,e){if(1&t&&(h.Tb(0,"div",27),h.Dc(1),h.Sb()),2&t){const t=h.ec().$implicit,e=h.ec().$implicit;h.Bb(1),h.Fc(" ",t[e]," ")}}const x=function(t){return{tableLabel:t}};function k(t,e){if(1&t&&(h.Tb(0,"td",22),h.Bc(1,T,2,1,"div",23),h.Bc(2,y,2,1,"ng-template",null,24,h.Cc),h.Sb()),2&t){const t=e.index,i=h.qc(3),n=h.ec().index,s=h.ec().index,o=h.ec(2);h.kc("ngClass",h.oc(3,x,o.isLabelCell(s,t,n))),h.Bb(1),h.kc("ngIf",!1!==o.isInputCell(s,t,n))("ngIfElse",i)}}function I(t,e){1&t&&(h.Rb(0,19),h.Bc(1,D,1,0,"mat-header-cell",20),h.Bc(2,k,4,5,"td",21),h.Qb()),2&t&&h.lc("matColumnDef",e.$implicit)}function B(t,e){1&t&&h.Ob(0,"tr",28)}function O(t,e){1&t&&h.Ob(0,"tr",29)}function F(t,e){if(1&t&&(h.Tb(0,"div",1),h.Tb(1,"p"),h.Dc(2),h.Sb(),h.Tb(3,"table",15),h.Bc(4,I,3,1,"ng-container",16),h.Bc(5,B,1,0,"tr",17),h.Bc(6,O,1,0,"tr",18),h.Sb(),h.Sb()),2&t){const t=e.$implicit,i=e.index,n=h.ec(2);h.Bb(2),h.Ec(n.form.elements[i].name),h.Bb(1),h.kc("dataSource",t.value)("formArrayName",t.id),h.Bb(1),h.kc("ngForOf",t.displayedColumns),h.Bb(1),h.kc("matHeaderRowDef",t.displayedColumns),h.Bb(1),h.kc("matRowDefColumns",t.displayedColumns)}}function L(t,e){if(1&t&&(h.Tb(0,"div",13),h.Bc(1,F,7,6,"div",14),h.Sb()),2&t){const t=h.ec();h.kc("formGroup",t.inputForm.get("values")),h.Bb(1),h.kc("ngForOf",t.tables)}}function R(t,e){if(1&t){const t=h.Ub();h.Tb(0,"button",30),h.ac("click",(function(){return h.sc(t),h.ec().deleteInput()})),h.Tb(1,"mat-icon"),h.Dc(2,"clear"),h.Sb(),h.Dc(3),h.fc(4,"translate"),h.Sb()}2&t&&(h.Bb(3),h.Fc(" ",h.gc(4,1,"Delete")," "))}const N=[{path:"**",component:(()=>{class t{constructor(t,e,i,n,s,o,c){this.route=t,this.projectService=e,this.translateService=i,this.datepipe=n,this.fb=s,this.inputService=o,this.router=c,this.subscription=new r.a,this.site=new l.a({name:""}),this.form=new a.a({name:""}),this.firstDate="",this.lastDate="",this.tables=[]}get currentLang(){return this.translateService.currentLang?this.translateService.currentLang:this.translateService.defaultLang}ngOnInit(){this.subscription.add(this.projectService.openedProject.subscribe(t=>{this.project=t,this.updateData()})),this.subscription.add(this.route.params.subscribe(t=>{this.formId=t.formId,this.siteId=t.siteId,this.timeSlotDate=t.timeSlot,this.updateData()}))}updateData(){return Object(o.b)(this,void 0,void 0,(function*(){if(this.project&&(this.formId&&(this.form=this.project.forms.find(t=>t.id===this.formId)),this.siteId&&(this.site=this.project.entities.find(t=>t.id===this.siteId)),this.timeSlotDate&&this.form)){this.timeSlot=new u.a(this.timeSlotDate);const t={weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"UTC"};this.firstDate=this.timeSlot.firstDate.toLocaleDateString(this.currentLang,t),this.lastDate=this.timeSlot.lastDate.toLocaleDateString(this.currentLang,t),this.previousTimeSlot=this.timeSlot.previous();const e=this.previousTimeSlot.value;this.inputService.get(this.project.id,this.site.id,this.form.id,e).then(t=>{t&&t.length>0&&void 0!==(t=t.find(t=>t.period===e))&&(this.previousInput=new b.a(t))})}if(this.project&&this.form&&this.timeSlotDate){let t=yield this.getInput();t&&t.length>0&&(t=t.find(t=>t.period===this.timeSlotDate),void 0!==t&&(this.input=new b.a(t))),this.createForm(),this.createTable(),this.updateTotals(this.inputForm.value),this.inputForm.valueChanges.subscribe(t=>{this.convertToNumber(t),this.updateTotals(t)})}}))}createForm(){const t={};for(const i of this.form.elements)t[i.id]=this.fb.array(this.input&&this.input.values&&this.input.values[i.id]?this.input.values[i.id]:Array.from({length:this.countInputCells(i)},(t,e)=>0));const e={_id:this.input&&this.input.id?this.input.id:`input:${this.project.id}:${this.form.id}:${this.site.id}:${this.timeSlotDate}`,entity:this.site.id,form:this.form.id,period:this.timeSlotDate,project:this.project.id,rev:this.input&&this.input.rev?this.input.rev:null,values:this.fb.group(t)};this.inputForm=this.fb.group(e)}convertToNumber(t){for(const e of this.form.elements)t.values[e.id]=t.values[e.id].map(t=>+t)}updateTotals(t){for(let e=0;e<this.tables.length;e+=1){const i=this.tables[e];let n,s,o=0;for(n=i.cols.length;n<i.numberRows-1;n+=1){let r=0;for(s=0;s<i.numberCols;s+=1){const o=this.isInputCell(e,n,s);!1!==o&&(r+=t.values[i.id][o])}i.value[n][i.numberCols-1]=r,o+=r}for(i.value[i.numberRows-1][i.numberCols-1]=o,o=0,s=i.rows.length;s<i.numberCols-1;s+=1){let r=0;for(n=0;n<i.numberRows;n+=1){const o=this.isInputCell(e,n,s);!1!==o&&(r+=+t.values[i.id][o])}i.value[i.numberRows-1][s]=r,o+=r}0!==o&&(i.value[i.numberRows-1][i.numberCols-1]=o)}}createTable(){for(const t of this.form.elements){const e=[],i=[];this.numberCols=0,this.numberRows=0;let n=0;for(n=0;n<t.distribution;n+=1)i.push(t.partitions[n]),0===this.numberRows&&(this.numberRows=1),this.numberRows*=t.partitions[n].elements.length;for(n=t.distribution;n<t.partitions.length;n+=1)e.push(t.partitions[n]),0===this.numberCols&&(this.numberCols=1),this.numberCols*=t.partitions[n].elements.length;for(this.numberRows=this.numberRows+e.length+1,this.numberCols=this.numberCols+i.length+1,this.table=[],n=0;n<this.numberRows;n+=1){this.table.push([]);for(let t=0;t<this.numberCols;t+=1)this.table[n].push(n<e.length||t<i.length?"":0)}this.fillCollumnLabels(i,e),this.fillRowLabels(i,e),this.fillTotalLabels(i,e);const s=[];for(let t=0;t<this.numberCols;t+=1)s.push(t.toString());this.tables.push({id:t.id,value:this.table,cols:e,rows:i,numberCols:this.numberCols,numberRows:this.numberRows,displayedColumns:s})}}fillTotalLabels(t,e){if(e.length>0){const t=this.numberCols-1;for(let i=0;i<e.length;i+=1)this.table[i][t]="Total"}if(t.length>0){const e=this.numberRows-1;for(let i=0;i<t.length;i+=1)this.table[e][i]="Total"}}fillRowLabels(t,e){this.x=e.length,this.y=0,this.fillCurrentRowLabel(t,e,0)}fillCurrentRowLabel(t,e,i){if(!(i>=t.length))if(i!==t.length-1)for(const n of t[i].elements)this.table[this.x][this.y]=n.name,this.y+=1,this.fillCurrentRowLabel(t,e,i+1),this.y-=1;else for(const n of t[i].elements)this.table[this.x][this.y]=n.name,this.x+=1}fillCollumnLabels(t,e){this.x=0,this.y=t.length,this.fillCurrentColLabel(t,e,0)}fillCurrentColLabel(t,e,i){if(!(i>=e.length))if(i!==e.length-1)for(const n of e[i].elements)this.table[this.x][this.y]=n.name,this.x+=1,this.fillCurrentColLabel(t,e,i+1),this.x-=1;else for(const n of e[i].elements)this.table[this.x][this.y]=n.name,this.y+=1}countInputCells(t){const e=[],i=[];let n=1,s=1,o=0;for(o=0;o<t.distribution;o+=1)e.push(t.partitions[o]),n*=t.partitions[o].elements.length;for(o=t.distribution;o<t.partitions.length;o+=1)i.push(t.partitions[o]),s*=t.partitions[o].elements.length;return s*n}isLabelCell(t,e,i){return e<this.tables[t].cols.length||i<this.tables[t].rows.length}isInputCell(t,e,i){const n=this.tables[t].rows,s=this.tables[t].cols,o=this.tables[t].numberRows,r=this.tables[t].numberCols;if(e>=s.length&&(0===n.length||e<o-1)&&i>=n.length&&(0===s.length||i<r-1)){let t=o-s.length-1,a=r-n.length-1;return 0===s.length&&(a+=1),0===n.length&&(t+=1),(e-=s.length)*a+(i-n.length)}return!1}fillWithPreviousData(){if(this.previousInput)for(const t of this.form.elements)this.previousInput&&this.previousInput.values&&this.previousInput.values[t.id]&&this.inputForm.get("values").get(t.id).setValue(this.previousInput.values[t.id])}saveInput(){return Object(o.b)(this,void 0,void 0,(function*(){const t=new b.a(this.inputForm.value),e=yield this.inputService.save(t);e&&(this.input=new b.a(e),this.inputForm.get("rev").setValue(this.input.rev))}))}deleteInput(){return Object(o.b)(this,void 0,void 0,(function*(){const t=new b.a(this.inputForm.value);yield this.inputService.delete(t),this.router.navigate(["./../../../"],{relativeTo:this.route})}))}getInput(){return Object(o.b)(this,void 0,void 0,(function*(){return yield this.inputService.get(this.project.id,this.site.id,this.form.id,this.timeSlotDate)}))}get canBeSaved(){return!this.input||!(!this.inputForm||!this.input)&&JSON.stringify(this.inputForm.get("values").value)!==JSON.stringify(this.input.values)}get inputHasModification(){return!(!this.inputForm||!this.input)&&JSON.stringify(this.inputForm.get("values").value)!==JSON.stringify(this.input.values)}resetInput(){this.inputForm.get("values").setValue(this.input.values)}ngOnDestroy(){this.subscription.unsubscribe()}}return t.\u0275fac=function(e){return new(e||t)(h.Nb(s.a),h.Nb(m.a),h.Nb(f.d),h.Nb(n.e),h.Nb(d.f),h.Nb(p.a),h.Nb(s.b))},t.\u0275cmp=h.Hb({type:t,selectors:[["app-edit"]],decls:40,vars:31,consts:[[1,"mdm-title"],[1,"mdm-section"],[1,"info"],[1,"info-title"],[1,"info-value"],[1,"title"],["mat-stroked-button","","class","mdm-button small-button fill-button",3,"click",4,"ngIf"],[3,"formGroup",4,"ngIf"],[1,"save-actions"],["mat-stroked-button","",1,"mdm-button","primary",3,"disabled","click"],["mat-stroked-button","",1,"mdm-button",3,"disabled","click"],["mat-stroked-button","","class","mdm-button warn",3,"click",4,"ngIf"],["mat-stroked-button","",1,"mdm-button","small-button","fill-button",3,"click"],[3,"formGroup"],["class","mdm-section",4,"ngFor","ngForOf"],["mat-table","",1,"mdm-table","input-table",3,"dataSource","formArrayName"],[3,"matColumnDef",4,"ngFor","ngForOf"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],[3,"matColumnDef"],[4,"matHeaderCellDef"],["mat-cell","","class","input-td",3,"ngClass",4,"matCellDef"],["mat-cell","",1,"input-td",3,"ngClass"],["class","input-div",4,"ngIf","ngIfElse"],["elseBlock",""],[1,"input-div"],["matInput","",3,"formControl"],[1,"table-value"],["mat-header-row",""],["mat-row",""],["mat-stroked-button","",1,"mdm-button","warn",3,"click"]],template:function(t,e){1&t&&(h.Tb(0,"div",0),h.Dc(1),h.fc(2,"translate"),h.Sb(),h.Tb(3,"div",1),h.Tb(4,"div",2),h.Tb(5,"b",3),h.Dc(6),h.fc(7,"translate"),h.Sb(),h.Tb(8,"div",4),h.Dc(9),h.Sb(),h.Sb(),h.Tb(10,"div",2),h.Tb(11,"b",3),h.Dc(12),h.fc(13,"translate"),h.Sb(),h.Tb(14,"div",4),h.Dc(15),h.Sb(),h.Sb(),h.Tb(16,"div",2),h.Tb(17,"b",3),h.Dc(18),h.fc(19,"translate"),h.Sb(),h.Tb(20,"div",4),h.Dc(21),h.Sb(),h.Sb(),h.Sb(),h.Tb(22,"div",5),h.Bc(23,w,4,0,"button",6),h.Tb(24,"div",0),h.Dc(25),h.fc(26,"translate"),h.Sb(),h.Sb(),h.Bc(27,L,2,2,"div",7),h.Tb(28,"div",8),h.Tb(29,"button",9),h.ac("click",(function(){return e.saveInput()})),h.Tb(30,"mat-icon"),h.Dc(31,"save"),h.Sb(),h.Dc(32),h.fc(33,"translate"),h.Sb(),h.Tb(34,"button",10),h.ac("click",(function(){return e.resetInput()})),h.Tb(35,"mat-icon"),h.Dc(36,"replay"),h.Sb(),h.Dc(37),h.fc(38,"translate"),h.Sb(),h.Bc(39,R,5,3,"button",11),h.Sb()),2&t&&(h.Bb(1),h.Ec(h.gc(2,17,"GeneralInformations")),h.Bb(5),h.Ec(h.gc(7,19,"Name")),h.Bb(3),h.Ec(e.form?e.form.name:""),h.Bb(3),h.Ec(h.gc(13,21,"CollectionSites")),h.Bb(3),h.Ec(e.site?e.site.name:""),h.Bb(3),h.Ec(h.gc(19,23,"CoveredPeriod")),h.Bb(3),h.Hc("",e.timeSlot?e.timeSlot.humanizeValue(e.currentLang):""," (",e.firstDate," - ",e.lastDate,")"),h.Bb(2),h.kc("ngIf",e.previousInput),h.Bb(2),h.Fc(" ",h.gc(26,25,"Data")," "),h.Bb(2),h.kc("ngIf",e.inputForm&&e.tables),h.Bb(2),h.kc("disabled",!e.canBeSaved),h.Bb(3),h.Fc(" ",h.gc(33,27,"Save")," "),h.Bb(2),h.kc("disabled",!e.canBeSaved),h.Bb(3),h.Fc(" ",h.gc(38,29,"Reset changes")," "),h.Bb(2),h.kc("ngIf",e.input))},directives:[n.l,g.a,v.a,d.s,d.k,n.k,C.n,d.e,C.k,C.m,C.c,C.i,C.b,C.h,C.a,n.j,S.b,d.c,d.r,d.h,C.j,C.l],pipes:[f.c],styles:['@font-face{font-family:Neutra-Text;src:url(/assets/fonts/Neutra-Text_32171.ttf) format("truetype")}@font-face{font-family:Neutra-Text;src:url(/assets/fonts/Neutra-Text-Bold_32106.ttf) format("truetype");font-weight:700}@font-face{font-family:Neutra-Text-Light;src:url(/assets/fonts/Neutra-Text-Light_32131.ttf) format("truetype")}@font-face{font-family:Neutra-Text-Light-Demi;src:url(/assets/fonts/Neutra-Text-Light-Demi_32117.ttf) format("truetype")}.mdm-section[_ngcontent-%COMP%]{margin-top:34px;padding:16px;background-color:#fafafa;box-shadow:0 4px 8px 0 rgba(0,0,0,.04)!important;border-radius:4px}.mdm-section[_ngcontent-%COMP%]   .info[_ngcontent-%COMP%]{display:flex;padding-bottom:10px}.mdm-section[_ngcontent-%COMP%]   .info[_ngcontent-%COMP%]   .info-title[_ngcontent-%COMP%]{width:20%;text-align:right}.mdm-section[_ngcontent-%COMP%]   .info[_ngcontent-%COMP%]   .info-value[_ngcontent-%COMP%]{padding-left:20px;width:80%}.title[_ngcontent-%COMP%]{width:100%}.title[_ngcontent-%COMP%]   .fill-button[_ngcontent-%COMP%]{float:right}.save-actions[_ngcontent-%COMP%]{position:fixed;bottom:0;right:0;background-color:#fff;width:calc(100% - 250px);box-sizing:border-box;padding:12px 16px;box-shadow:0 1px 6px 0 rgba(0,0,0,.1)}@media screen and (max-width:1023px){.save-actions[_ngcontent-%COMP%]{width:100%}}.save-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin-right:8px}.save-actions[_ngcontent-%COMP%]   button.warn[_ngcontent-%COMP%]{background-color:#f44336;color:#fff}.save-actions[_ngcontent-%COMP%]   button.primary[_ngcontent-%COMP%]{background-color:#337ab7;color:#fff}.save-actions[_ngcontent-%COMP%]   button.primary.mat-stroked-button.mat-button-disabled.mat-button-disabled[_ngcontent-%COMP%]{opacity:.65}']}),t})()}];let P=(()=>{class t{}return t.\u0275mod=h.Lb({type:t}),t.\u0275inj=h.Kb({factory:function(e){return new(e||t)},imports:[[s.f.forChild(N)],s.f]}),t})();var _=i("kmnG");let M=(()=>{class t{}return t.\u0275mod=h.Lb({type:t}),t.\u0275inj=h.Kb({factory:function(e){return new(e||t)},imports:[[n.c,P,d.m,f.b,C.p,g.b,_.d,v.b,S.c,d.w]]}),t})()}}]);