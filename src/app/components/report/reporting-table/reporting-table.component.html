<div class="table-scroll {{ isCrossCuttingReport ? 'big-table' : null }}">
  <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="mat-elevation-z8">
    <ng-container class="menu" matColumnDef="icon" [sticky]="true">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let element"> 
        <button *ngIf="element.icon" [disabled]="element.error" class="mdm-button small-button mat-icon-button {{element.onChart ? 'clicked' : null }} {{element.error ? 'disabled' : null}}" (click)="updateChart(element)">
          <mat-icon>insights</mat-icon>
        </button>
      </td>
    </ng-container>
  
    <ng-container matColumnDef="name" [sticky]="true">
      <th mat-header-cell *matHeaderCellDef>{{ 'Name' | translate }}</th>
      <td mat-cell *matCellDef="let element" [style]="calcPaddingLevel(element)">
        <div class="menu">
          <div matTooltip="{{element.name}}" [matTooltipShowDelay]="500">{{element.name}}</div>
          <app-reporting-menu [indicator]="element" [dimensionName]="dimensionIds.value" (addIndicatorsEvent)="receiveIndicators($event)" (collapseIndicatorsEvent)="collapseIndicators($event)" [isCrossCuttingReport]="isCrossCuttingReport"></app-reporting-menu>
        </div>
      </td>
    </ng-container>
  
    <ng-container matColumnDef="baseline" [sticky]="true">
      <th mat-header-cell *matHeaderCellDef >{{ 'Baseline' | translate }}</th>
      <td mat-cell *matCellDef="let element" class="gradient-background">{{ element.baseline !== null ? element.baseline : null }}{{ element.baseline !== null ? element.unit : null}}</td>
    </ng-container>
  
    <ng-container matColumnDef="target" [sticky]="true">
      <th mat-header-cell *matHeaderCellDef>{{ 'Target' | translate }}</th>
      <td mat-cell *matCellDef="let element" class="gradient-background"> {{element.target !== null ? element.target : null}}{{ element.target !== null ? element.unit : null }}</td>
    </ng-container>
    
    <ng-container matColumnDef="error">
      <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length - 4" class="error">
        <span *ngFor="let err of element.error">{{ err | translate}} </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="{{column}}" *ngFor="let column of dimensions" [stickyEnd]="column === '_total'">
      <th matTooltip="{{getSiteOrGroupName(column) | translate}}"  [matTooltipShowDelay]="500" mat-header-cell *matHeaderCellDef>{{ getSiteOrGroupName(column) | translate }}</th>
      <td mat-cell class="value-cell" *matCellDef="let element" [ngStyle]="{ 'backgroundColor': element.values[column] !== undefined ? calcColor(element, column) : 'rgb(238, 238, 238)' }">
        <div *ngIf="checkIfNaN(element?.values[column]); else elseNumber">
          <mat-icon class="mat-icon NaN">do_disturb</mat-icon>
        </div>
        <ng-template #elseNumber>
          {{ element.values[column] !== undefined ? (element.values[column].toLocaleString() ) : null }}{{ (element.unit && element.values[column]) ? element.unit : null }}
        </ng-template>
      </td>
    </ng-container>

    <!-- Sticky position doesnt allow a dynamic column span so they have been set as static-->
    <ng-container matColumnDef="title" [sticky]="true">
      <ng-container *ngIf="columnsToDisplay.length === 4">
        <td mat-cell *matCellDef="let element" [attr.colspan]="3" class="title">
          <div>
          <mat-icon *ngIf="!element.open; else elseOpen">add_circle</mat-icon>
          <ng-template #elseOpen>
            <mat-icon>remove_circle</mat-icon>
          </ng-template>
             {{ element['title'] }}
        </div>
        </td>
      </ng-container>
      <ng-container *ngIf="columnsToDisplay.length === 5">
        <td mat-cell *matCellDef="let element" [attr.colspan]="4" class="title">
          <div>
          <mat-icon *ngIf="!element.open; else elseOpen">add_circle</mat-icon>
          <ng-template #elseOpen>
            <mat-icon>remove_circle</mat-icon>
          </ng-template>
             {{ element['title'] }}
        </div>
        </td>
      </ng-container>
      <ng-container *ngIf="columnsToDisplay.length === 6">
        <td mat-cell *matCellDef="let element" [attr.colspan]="5" class="title">
          <div>
          <mat-icon *ngIf="!element.open; else elseOpen">add_circle</mat-icon>
          <ng-template #elseOpen>
            <mat-icon>remove_circle</mat-icon>
          </ng-template>
             {{ element['title'] }}
        </div>
        </td>
      </ng-container>
      <ng-container *ngIf="columnsToDisplay.length === 7">
        <td mat-cell *matCellDef="let element" [attr.colspan]="6" class="title">
          <div>
          <mat-icon *ngIf="!element.open; else elseOpen">add_circle</mat-icon>
          <ng-template #elseOpen>
            <mat-icon>remove_circle</mat-icon>
          </ng-template>
             {{ element['title'] }}
        </div>
        </td>
      </ng-container>
      <ng-container *ngIf="columnsToDisplay.length === 8">
        <td mat-cell *matCellDef="let element" [attr.colspan]="7" class="title">
          <div>
          <mat-icon *ngIf="!element.open; else elseOpen">add_circle</mat-icon>
          <ng-template #elseOpen>
            <mat-icon>remove_circle</mat-icon>
          </ng-template>
             {{ element['title'] }}
        </div>
        </td>
      </ng-container>
      <ng-container *ngIf="columnsToDisplay.length >= 9">
        <td mat-cell *matCellDef="let element" [attr.colspan]="8" class="title">
          <div>
          <mat-icon *ngIf="!element.open; else elseOpen">add_circle</mat-icon>
          <ng-template #elseOpen>
            <mat-icon>remove_circle</mat-icon>
          </ng-template>
             {{ element['title'] }}
        </div>
        </td>
      </ng-container>
    </ng-container>

    <!-- The rest of the row needs to be filled out to keep consistent styling -->
    <ng-container matColumnDef="title_stick" *ngIf="columnsToDisplay">
      <td mat-cell *matCellDef="" [attr.colspan]="columnsToDisplay.length >= 9 ? columnsToDisplay.length - 8 : 0"></td>
    </ng-container>
  
    <ng-container matColumnDef="groupName" [sticky]="true">
      <ng-container *ngIf="optimalColspanForGroupName === 3">
        <td mat-cell *matCellDef="let element" [attr.colspan]="3" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 4" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="4" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 5">
        <td mat-cell *matCellDef="let element" [attr.colspan]="5" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>   
      <ng-container *ngIf="optimalColspanForGroupName === 6">
        <td mat-cell *matCellDef="let element" [attr.colspan]="6" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 7" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="7" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 8" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="8" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 9" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="9" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 10" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="10" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 11" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="11" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 12" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="12" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 13" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="13" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName === 14" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="14" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
      <ng-container *ngIf="optimalColspanForGroupName >= 15" >
        <td mat-cell *matCellDef="let element" [attr.colspan]="15" [style]="calcPaddingLevel(element)" class="groupName">{{element.groupName}}</td>
      </ng-container>
    </ng-container>

    <ng-container matColumnDef="group_stick" *ngIf="columnsToDisplay">
      <td mat-cell *matCellDef="" [attr.colspan]="columnsToDisplay.length - optimalColspanForGroupName - 1"></td>
    </ng-container>
  
    <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
    <tr mat-row *matRowDef="let element; columns: COLUMNS_TO_DISPLAY_TITLE; when: isSectionTitle" 
        class="example-element-row"
        (click)="toggleSection(element)"
    ></tr>
    
    <tr mat-row *matRowDef="let element; columns: columnsToDisplay; when: isInfoRowNoError"></tr>
    <tr mat-row *matRowDef="let element; columns: COLUMNS_TO_DISPLAY_ERROR; when: isInfoRowError"></tr>
    <tr mat-row *matRowDef="let element; columns: COLUMNS_TO_DISPLAY_GROUP; when: isGroupTitle"></tr>
  </table>
</div>